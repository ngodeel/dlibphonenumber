name: 自动优化并合并固话 (运行在 dlib)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  optimize-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests pandas pypinyin

      # =========================================================
      # 核心脚本：已修复转换逻辑（递归优化 + 标准Dart格式）
      # =========================================================
      - name: Process Data
        run: |
          cat > run_process.py << 'EOF'
          import requests
          import pandas as pd
          import os
          import re
          from collections import defaultdict
          from pypinyin import lazy_pinyin, Style

          # === 配置部分 ===
          SQL_URL = "https://github.com/dannyhu926/phone_location/raw/refs/heads/master/mysql/phone_location.sql"
          FIXED_ZH_URL = "https://raw.githubusercontent.com/haygcao/vccard/dartnumber/lib/merged/fixed_line_zh.dart"
          FIXED_EN_URL = "https://raw.githubusercontent.com/haygcao/vccard/dartnumber/lib/merged/fixed_line_en.dart"

          OUTPUT_ZH = "lib/generated/metadata/geocoding/86_zh.dart"
          OUTPUT_EN = "lib/generated/metadata/geocoding/86_en.dart"

          # === 辅助函数 ===
          def convert_to_pinyin(province, city):
              p = ''.join(lazy_pinyin(province if province else "", style=Style.NORMAL))
              c = ''.join(lazy_pinyin(city if city else "", style=Style.NORMAL))
              if not city: return p.title()
              return f"{c.title()}, {p.title()}"

          def fetch_remote_lines(url):
              """下载并提取Map内容，确保每行格式正确且无末尾逗号(以便统一处理)"""
              print(f"Fetching {url}...")
              try:
                  resp = requests.get(url)
                  resp.raise_for_status()
                  match = re.search(r'return\s*\{([\s\S]*?)\};', resp.text)
                  lines = []
                  if match:
                      for line in match.group(1).split('\n'):
                          clean = line.strip()
                          if clean:
                              if clean.endswith(','): clean = clean[:-1]
                              lines.append(clean)
                  return lines
              except Exception as e:
                  print(f"Error fetching {url}: {e}")
                  return []

          def optimize_one_round(data_list):
              """单轮优化逻辑：同归属地下，凑齐0-9则合并"""
              optimized_result = []
              # 1. 按 (省, 市) 分组
              loc_groups = defaultdict(list)
              for item in data_list:
                  loc_groups[(item['province'], item['city'])].append(item)
              
              # 2. 组内尝试合并
              for (prov, city), items in loc_groups.items():
                  parent_groups = defaultdict(list)
                  for item in items:
                      phone_str = str(item['phone'])
                      parent = phone_str[:-1] # 父级前缀
                      parent_groups[parent].append(item)
                  
                  for parent, siblings in parent_groups.items():
                      if len(siblings) == 10:
                          # 凑齐10个，合并为短号
                          optimized_result.append({
                              'phone': parent,
                              'province': prov,
                              'city': city
                          })
                      else:
                          # 没凑齐，保留原样
                          optimized_result.extend(siblings)
              return optimized_result

          def main():
              # --- 第一步：解析 SQL ---
              print("1. Parsing SQL...")
              response = requests.get(SQL_URL)
              response.raise_for_status()
              
              insert_statements = [line for line in response.text.splitlines() if line.startswith("INSERT INTO `phone_location`")]
              raw_data = []
              for statement in insert_statements:
                  values_part = statement[statement.find("VALUES") + 6:].strip().strip(";")
                  rows = values_part.split("),(")
                  for row in rows:
                      row = row.replace("(", "").replace(")", "")
                      parts = [p.strip().strip("'") for p in row.split(",")]
                      if len(parts) >= 4:
                          raw_data.append({
                              'phone': '86' + parts[1], 
                              'province': parts[2], 
                              'city': parts[3]
                          })
              
              # --- 第二步：循环递归优化 (关键修改) ---
              print(f"2. Optimizing {len(raw_data)} records...")
              current_data = raw_data
              round_num = 0
              while True:
                  round_num += 1
                  new_data = optimize_one_round(current_data)
                  diff = len(current_data) - len(new_data)
                  print(f"   Round {round_num}: Reduced by {diff}")
                  # 如果这一轮没有减少任何数据，说明优化到底了，退出循环
                  if len(new_data) == len(current_data):
                      break
                  current_data = new_data
              
              final_data = sorted(current_data, key=lambda x: int(x['phone']))
              print(f"   Final count: {len(final_data)}")

              # --- 第三步：获取固话 ---
              print("3. Fetching Fixed Line Data...")
              fixed_zh_lines = fetch_remote_lines(FIXED_ZH_URL)
              fixed_en_lines = fetch_remote_lines(FIXED_EN_URL)

              # --- 第四步：写入文件 (修复格式：Key: "Value",) ---
              print("4. Writing Final Files...")
              os.makedirs(os.path.dirname(OUTPUT_ZH), exist_ok=True)

              # === 写入中文版 ===
              with open(OUTPUT_ZH, 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\n')
                  f.write('Map<int, String> get86_zh() {\n  return {\n')
                  
                  # 写入固话
                  for line in fixed_zh_lines:
                      f.write(f"    {line},\n")
                  
                  # 写入手机 (Key是数字，Value是字符串，末尾必须有逗号)
                  for row in final_data:
                      f.write(f'    {row["phone"]}: "{row["province"]}{row["city"]}",\n')
                      
                  f.write('  };\n}\n')

              # === 写入英文版 ===
              with open(OUTPUT_EN, 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\n')
                  f.write('Map<int, String> get86_en() {\n  return {\n')
                  
                  # 写入固话
                  for line in fixed_en_lines:
                      f.write(f"    {line},\n")
                  
                  # 写入手机
                  for row in final_data:
                      pinyin = convert_to_pinyin(row['province'], row['city'])
                      f.write(f'    {row["phone"]}: "{pinyin}",\n')
                      
                  f.write('  };\n}\n')
                  
              print("Done.")

          if __name__ == "__main__":
              main()
          EOF
          
          python run_process.py

      - name: Commit and Force Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): Auto optimize and merge fixed line data"
          file_pattern: "lib/generated/metadata/geocoding/86_*.dart"
          branch: main
          repository: .
          push_options: '--force'
