name: 优化0-9 末尾 循环压缩版

on:
  workflow_dispatch:
  schedule:
     - cron: '0 12 1 * *'
  
permissions:
  contents: write

jobs:
  convert-and-optimize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dartnumber

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests pypinyin pandas

      - name: Process Phone Location Data
        run: |
          cat > run_all.py << 'EOF'
          import requests
          import pandas as pd
          from collections import defaultdict
          from pypinyin import lazy_pinyin, Style
          import os

          # === 1. 下载与解析 (沿用你认可的逻辑) ===
          def get_raw_data():
              url = "https://github.com/dannyhu926/phone_location/raw/refs/heads/master/mysql/phone_location.sql"
              resp = requests.get(url)
              resp.raise_for_status()
              sql_content = resp.text

              insert_statements = [line for line in sql_content.splitlines() if line.startswith("INSERT INTO `phone_location`")]
              data = []
              for statement in insert_statements:
                  values_str = statement[statement.find("VALUES") + len("VALUES"):].strip().strip(";")
                  # 使用你代码中的思路解析 SQL
                  rows = values_str.split("),(")
                  for row in rows:
                      row = row.replace("(", "").replace(")", "")
                      parts = [p.strip().strip("'") for p in row.split(",")]
                      if len(parts) >= 4:
                          # parts[1]是号码, parts[2]是省, parts[3]是市
                          data.append({
                              'phone': '86' + parts[1],
                              'province': parts[2],
                              'city': parts[3]
                          })
              return data

          # === 2. 优化函数 (单轮合并) ===
          def optimize_round(items):
              processed_indices = set()
              result = []
              
              # 按归属地分组，确保只有同地点的号段才合并
              loc_groups = defaultdict(list)
              for i, item in enumerate(items):
                  loc_groups[f"{item['province']}{item['city']}"].append((i, item))

              for loc, group in loc_groups.items():
                  # 在同归属地内按前缀分组
                  prefix_map = defaultdict(list)
                  for idx, item in group:
                      prefix = item['phone'][:-1]
                      prefix_map[prefix].append((idx, item))
                  
                  for prefix, sub_group in prefix_map.items():
                      # 必须凑齐 0-9 共10个
                      if len(sub_group) == 10:
                          # 校验末尾是否是 0,1,2...9
                          suffixes = sorted([x[1]['phone'][-1] for x in sub_group])
                          if "".join(suffixes) == "0123456789":
                              first_item = sub_group[0][1]
                              result.append({
                                  'phone': prefix,
                                  'province': first_item['province'],
                                  'city': first_item['city']
                              })
                              for idx, _ in sub_group:
                                  processed_indices.add(idx)

              # 没被合并的保留
              for i, item in enumerate(items):
                  if i not in processed_indices:
                      result.append(item)
              return result

          # === 3. 拼音转换 ===
          def to_pinyin(province, city):
              p = ''.join(lazy_pinyin(province, style=Style.NORMAL))
              c = ''.join(lazy_pinyin(city, style=Style.NORMAL))
              return f"{c.title()}, {p.title()}"

          # === 主逻辑 ===
          def main():
              os.makedirs('lib/cn', exist_ok=True)
              
              # 获取原始数据
              current_data = get_raw_data()
              print(f"Initial: {len(current_data)} records.")

              # 循环优化直到无法再压缩
              round_num = 0
              while True:
                  round_num += 1
                  new_data = optimize_round(current_data)
                  if len(new_data) == len(current_data):
                      break
                  print(f"Round {round_num}: {len(current_data)} -> {len(new_data)}")
                  current_data = new_data

              # 排序
              current_data.sort(key=lambda x: int(x['phone']))

              # 写入 ZH 文件
              with open('lib/cn/phone_location_zh_optimized.dart', 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\nMap<int, String> get86_zh_optimized() {\n  return {\n')
                  for item in current_data:
                      # 修正：Value 只有省市
                      f.write(f'    {item["phone"]}: "{item["province"]}{item["city"]}",\n')
                  f.write('  };\n}\n')

              # 写入 EN 文件
              with open('lib/cn/phone_location_en_optimized.dart', 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\nMap<int, String> get86_en_optimized() {\n  return {\n')
                  for item in current_data:
                      en_val = to_pinyin(item['province'], item['city'])
                      f.write(f'    {item["phone"]}: "{en_val}",\n')
                  f.write('  };\n}\n')

          if __name__ == "__main__":
              main()
          EOF
          python run_all.py

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update Optimized Dart Phone Location Maps"
          file_pattern: "lib/cn/*.dart"
          branch: dartnumber
          repository: .
          token: ${{ secrets.YOUR_GITHUB_TOKEN }}
