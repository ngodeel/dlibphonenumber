name: 生成最终版归属地数据 (修复Token问题)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 1 * *'

permissions:
  contents: write

jobs:
  generate-final-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3  # 回退到 v3，和你之前的代码保持一致
        with:
          ref: main                # 确保这里是你要操作的分支
          token: ${{ secrets.YOUR_GITHUB_TOKEN }} # 【关键修复】显式加上 Token

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas pypinyin

      - name: Run Optimization and Generation Script
        run: |
          cat > generate_final.py << 'EOF'
          import requests
          import pandas as pd
          import os
          import re
          from collections import defaultdict
          from pypinyin import lazy_pinyin, Style

          # ================= 配置区域 =================
          SQL_URL = "https://github.com/dannyhu926/phone_location/raw/refs/heads/master/mysql/phone_location.sql"
          FIXED_ZH_URL = "https://raw.githubusercontent.com/haygcao/vccard/dartnumber/lib/merged/fixed_line_zh.dart"
          FIXED_EN_URL = "https://raw.githubusercontent.com/haygcao/vccard/dartnumber/lib/merged/fixed_line_en.dart"

          OUTPUT_ZH = "lib/generated/metadata/geocoding/86_zh.dart"
          OUTPUT_EN = "lib/generated/metadata/geocoding/86_en.dart"
          # ===========================================

          def convert_to_pinyin(province, city):
              p = ''.join(lazy_pinyin(province if province else "", style=Style.NORMAL))
              c = ''.join(lazy_pinyin(city if city else "", style=Style.NORMAL))
              if not city: return p.title()
              return f"{c.title()}, {p.title()}"

          def fetch_fixed_lines(url):
              print(f"Fetching fixed lines from {url}...")
              try:
                  resp = requests.get(url)
                  resp.raise_for_status()
                  match = re.search(r'return\s*\{([\s\S]*?)\};', resp.text)
                  lines = []
                  if match:
                      for line in match.group(1).split('\n'):
                          clean = line.strip()
                          if clean:
                              if clean.endswith(','): clean = clean[:-1]
                              lines.append(clean)
                  return lines
              except Exception as e:
                  print(f"Error fetching fixed lines: {e}")
                  return []

          def process_optimization_round(df):
              processed_phones = set()
              result = []
              # 1. 按 (省+市) 分组
              location_groups = defaultdict(list)
              for _, row in df.iterrows():
                  phone_str = str(row['phone'])
                  key = f"{row['province']}|{row['city']}"
                  location_groups[key].append({
                      'phone': phone_str,
                      'province': row['province'],
                      'city': row['city']
                  })

              # 2. 组内按前缀合并
              for key, items in location_groups.items():
                  prefix_groups = defaultdict(list)
                  for item in items:
                      if item['phone'] not in processed_phones:
                          parent_prefix = item['phone'][:-1]
                          prefix_groups[parent_prefix].append(item)

                  for prefix, group in prefix_groups.items():
                      if len(group) == 10:
                          sorted_group = sorted(group, key=lambda x: x['phone'])
                          if all(int(n['phone'][-1]) == i for i, n in enumerate(sorted_group)):
                              first = sorted_group[0]
                              result.append({
                                  'phone': prefix,
                                  'province': first['province'],
                                  'city': first['city']
                              })
                              for n in sorted_group:
                                  processed_phones.add(n['phone'])
              
              # 3. 处理未合并的
              for _, row in df.iterrows():
                  phone_str = str(row['phone'])
                  if phone_str not in processed_phones:
                      result.append({
                          'phone': phone_str,
                          'province': row['province'],
                          'city': row['city']
                      })
              return result

          def main():
              print("1. Downloading SQL...")
              response = requests.get(SQL_URL)
              response.raise_for_status()
              
              insert_statements = [line for line in response.text.splitlines() if line.startswith("INSERT INTO `phone_location`")]
              raw_data = []
              for statement in insert_statements:
                  values_part = statement[statement.find("VALUES") + 6:].strip().strip(";")
                  rows = values_part.split("),(")
                  for row in rows:
                      row = row.replace("(", "").replace(")", "")
                      parts = [p.strip().strip("'") for p in row.split(",")]
                      if len(parts) >= 4:
                          raw_data.append({
                              'phone': '86' + parts[1], 
                              'province': parts[2], 
                              'city': parts[3]
                          })
              
              current_df = pd.DataFrame(raw_data)
              
              # Round 1
              print("2. Optimizing Round 1...")
              round1_list = process_optimization_round(current_df)
              round1_df = pd.DataFrame(round1_list)
              print(f"   Reduced: {len(current_df)} -> {len(round1_df)}")

              # Round 2
              print("3. Optimizing Round 2...")
              round2_list = process_optimization_round(round1_df)
              final_mobile_data = sorted(round2_list, key=lambda x: int(x['phone']))
              print(f"   Reduced: {len(round1_df)} -> {len(final_mobile_data)}")

              # Fetch Fixed Lines
              print("4. Fetching Fixed Lines...")
              fixed_zh = fetch_fixed_lines(FIXED_ZH_URL)
              fixed_en = fetch_fixed_lines(FIXED_EN_URL)

              # Write Files
              print("5. Writing Files...")
              os.makedirs(os.path.dirname(OUTPUT_ZH), exist_ok=True)

              with open(OUTPUT_ZH, 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\n')
                  f.write('Map<int, String> get86_zh() {\n  return {\n')
                  for line in fixed_zh:
                      f.write(f"    {line},\n")
                  for item in final_mobile_data:
                      f.write(f'    {item["phone"]}: "{item["province"]}{item["city"]}",\n')
                  f.write('  };\n}\n')

              with open(OUTPUT_EN, 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\n')
                  f.write('Map<int, String> get86_en() {\n  return {\n')
                  for line in fixed_en:
                      f.write(f"    {line},\n")
                  for item in final_mobile_data:
                      pinyin = convert_to_pinyin(item['province'], item['city'])
                      f.write(f'    {item["phone"]}: "{pinyin}",\n')
                  f.write('  };\n}\n')

              print("Done.")

          if __name__ == "__main__":
              main()
          EOF
          python generate_final.py

      - name: Commit and Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Update optimized phone location maps"
          file_pattern: "lib/generated/metadata/geocoding/86_*.dart"
          branch: main
          repository: .
          token: ${{ secrets.YOUR_GITHUB_TOKEN }} # 【关键修复】这里必须加上 Token
