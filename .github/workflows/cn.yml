name: 自动优化并合并固话 (运行在 dlib)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  optimize-and-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests pandas pypinyin

      # =========================================================
      # 核心脚本：完全移植 Stage 4 逻辑 (2轮) + 格式修正
      # =========================================================
      - name: Process Data
        run: |
          cat > run_process.py << 'EOF'
          import requests
          import pandas as pd
          import os
          import re
          from collections import defaultdict
          from pypinyin import lazy_pinyin, Style

          # === 配置部分 ===
          SQL_URL = "https://github.com/dannyhu926/phone_location/raw/refs/heads/master/mysql/phone_location.sql"
          FIXED_ZH_URL = "https://raw.githubusercontent.com/haygcao/vccard/dartnumber/lib/merged/fixed_line_zh.dart"
          FIXED_EN_URL = "https://raw.githubusercontent.com/haygcao/vccard/dartnumber/lib/merged/fixed_line_en.dart"

          OUTPUT_ZH = "lib/generated/metadata/geocoding/86_zh.dart"
          OUTPUT_EN = "lib/generated/metadata/geocoding/86_en.dart"

          # === 辅助函数 ===
          def convert_to_pinyin(province, city):
              p = ''.join(lazy_pinyin(province if province else "", style=Style.NORMAL))
              c = ''.join(lazy_pinyin(city if city else "", style=Style.NORMAL))
              if not city: return p.title()
              return f"{c.title()}, {p.title()}"

          def fetch_remote_lines(url):
              """下载并提取Map内容，去除末尾逗号以便统一处理"""
              print(f"Fetching {url}...")
              try:
                  resp = requests.get(url)
                  resp.raise_for_status()
                  match = re.search(r'return\s*\{([\s\S]*?)\};', resp.text)
                  lines = []
                  if match:
                      for line in match.group(1).split('\n'):
                          clean = line.strip()
                          if clean:
                              if clean.endswith(','): clean = clean[:-1]
                              lines.append(clean)
                  return lines
              except Exception as e:
                  print(f"Error fetching {url}: {e}")
                  return []

          # === 核心算法：1:1 复刻你的 Stage 4 process_csv 逻辑 ===
          def process_stage4_logic(df):
              processed = set()
              result = []
              location_groups = defaultdict(list)

              # 1. 你的逻辑：按 (省+市) 分组
              for _, row in df.iterrows():
                  phone = str(row['phone'])
                  key = f"{row['province']}{row['city']}"
                  location_groups[key].append({
                      'phone': phone,
                      'province': row['province'],
                      'city': row['city']
                  })

              # 2. 你的逻辑：组内查找 0-9 连续并合并
              for location, numbers in location_groups.items():
                  prefix_groups = defaultdict(list)
                  for num in numbers:
                      if num['phone'] not in processed:
                          prefix = num['phone'][:-1] # 取前缀
                          prefix_groups[prefix].append(num)

                  for prefix, group in prefix_groups.items():
                      # 你的逻辑：必须刚好 10 个
                      if len(group) == 10:
                          # 你的逻辑：严格排序并检查尾数是否为 0-9
                          sorted_group = sorted(group, key=lambda x: x['phone'])
                          if all(int(n['phone'][-1]) == i for i, n in enumerate(sorted_group)):
                              first = sorted_group[0]
                              # 你的逻辑：再次校验归属地一致性
                              if all(n['province'] == first['province'] and n['city'] == first['city'] for n in sorted_group):
                                  result.append({
                                      'phone': int(prefix), # 合并为短号
                                      'province': first['province'],
                                      'city': first['city']
                                  })
                                  processed.update(n['phone'] for n in sorted_group)

              # 3. 你的逻辑：处理未被合并的剩余号码
              for _, row in df.iterrows():
                  phone = str(row['phone'])
                  if phone not in processed:
                      result.append({
                          'phone': int(phone),
                          'province': row['province'],
                          'city': row['city']
                      })
              return result

          def main():
              # --- 步骤 1：解析 SQL ---
              print("1. Parsing SQL...")
              response = requests.get(SQL_URL)
              response.raise_for_status()
              
              insert_statements = [line for line in response.text.splitlines() if line.startswith("INSERT INTO `phone_location`")]
              raw_data = []
              for statement in insert_statements:
                  values_part = statement[statement.find("VALUES") + 6:].strip().strip(";")
                  rows = values_part.split("),(")
                  for row in rows:
                      row = row.replace("(", "").replace(")", "")
                      parts = [p.strip().strip("'") for p in row.split(",")]
                      if len(parts) >= 4:
                          raw_data.append({
                              'phone': '86' + parts[1], 
                              'province': parts[2], 
                              'city': parts[3]
                          })
              
              current_df = pd.DataFrame(raw_data)
              print(f"   Initial count: {len(current_df)}")

              # --- 步骤 2：执行两轮优化 (复刻 Stage 4 optimize_phone_ranges) ---
              
              # Round 1 (对应你脚本里的 first_round)
              print("2. Running Optimization Round 1...")
              round1_list = process_stage4_logic(current_df)
              round1_df = pd.DataFrame(round1_list)
              print(f"   Round 1 reduced to: {len(round1_df)}")

              # Round 2 (对应你脚本里的 second_round)
              print("3. Running Optimization Round 2...")
              round2_list = process_stage4_logic(round1_df)
              
              # 排序 (对应你脚本里的 final_df.sort_values)
              final_data = sorted(round2_list, key=lambda x: x['phone'])
              print(f"   Final optimized count: {len(final_data)}")

              # --- 步骤 3：获取固话 ---
              print("4. Fetching Fixed Line Data...")
              fixed_zh_lines = fetch_remote_lines(FIXED_ZH_URL)
              fixed_en_lines = fetch_remote_lines(FIXED_EN_URL)

              # --- 步骤 4：写入文件 (修正格式 Key: "Value",) ---
              print("5. Writing Final Files...")
              os.makedirs(os.path.dirname(OUTPUT_ZH), exist_ok=True)

              # === 写入中文版 ===
              with open(OUTPUT_ZH, 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\n')
                  f.write('Map<int, String> get86_zh() {\n  return {\n')
                  
                  # 写入固话
                  for line in fixed_zh_lines:
                      f.write(f"    {line},\n")
                  
                  # 写入手机 (修正：Value 只写省市，不包含手机号)
                  for row in final_data:
                      f.write(f'    {row["phone"]}: "{row["province"]}{row["city"]}",\n')
                      
                  f.write('  };\n}\n')

              # === 写入英文版 ===
              with open(OUTPUT_EN, 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions\n')
                  f.write('Map<int, String> get86_en() {\n  return {\n')
                  
                  # 写入固话
                  for line in fixed_en_lines:
                      f.write(f"    {line},\n")
                  
                  # 写入手机
                  for row in final_data:
                      pinyin = convert_to_pinyin(row['province'], row['city'])
                      f.write(f'    {row["phone"]}: "{pinyin}",\n')
                      
                  f.write('  };\n}\n')
                  
              print("Done.")

          if __name__ == "__main__":
              main()
          EOF
          
          python run_process.py

      - name: Commit and Force Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): Auto optimize and merge fixed line data"
          file_pattern: "lib/generated/metadata/geocoding/86_*.dart"
          branch: main
          repository: .
          push_options: '--force'
