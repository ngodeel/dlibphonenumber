name: è‡ªåŠ¨è¦†ç›–ä¿®æ­£æ–‡ä»¶

on:
  push:
    branches:
      - main  # åªè¦ main è¢«è‡ªåŠ¨æ›´æ–°äº†ï¼Œè¿™é‡Œå°±ä¼šè§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  overwrite-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests pypinyin pandas

      # =========================================================
      # æ‰§è¡Œä½ çš„å¤„ç†é€»è¾‘
      # =========================================================
      - name: Process and Overwrite Files
        run: |
          # 1. ä¸‹è½½ SQL å¹¶è½¬ CSV
          cat > run_all.py << 'EOF'
          import requests
          import pandas as pd
          import csv
          import os
          from collections import defaultdict
          from pypinyin import lazy_pinyin, Style

          # --- å‡½æ•°å®šä¹‰åŒº ---

          def download_and_convert_sql():
              print("Downloading SQL...")
              url = "https://github.com/dannyhu926/phone_location/raw/refs/heads/master/mysql/phone_location.sql"
              response = requests.get(url)
              response.raise_for_status()
              
              print("Converting SQL to CSV...")
              insert_statements = [line for line in response.text.splitlines() if line.startswith("INSERT INTO `phone_location`")]
              data = []
              for statement in insert_statements:
                  values_str = statement[statement.find("VALUES") + len("VALUES"):].strip()
                  values = []
                  in_quote = False
                  current_value = ""
                  for char in values_str:
                      if char == "'":
                          in_quote = not in_quote
                      elif char == "," and not in_quote:
                          values.append(current_value.strip("'"))
                          current_value = ""
                      elif in_quote:
                          current_value += char
                  values.append(current_value.strip("'"))
                  data.append(values[1:5])
              
              df = pd.DataFrame(data, columns=['pref', 'phone', 'province', 'city'])
              os.makedirs('lib/cn', exist_ok=True)
              df.to_csv('lib/cn/phone_location.csv', index=False, quoting=csv.QUOTE_NONNUMERIC)

          def preprocess_csv():
              print("Preprocessing CSV...")
              df = pd.read_csv('lib/cn/phone_location.csv')
              df = df.drop(columns=['pref'])
              df['phone'] = '86' + df['phone'].astype(str).str.replace("'", "")
              df['province'] = df['province'].str.replace("'", "")
              df['city'] = df['city'].str.replace("'", "")
              # è¿”å› DataFrame è€Œä¸æ˜¯å­˜æ–‡ä»¶ï¼Œå‡å°‘ IO
              return df

          def convert_to_pinyin(province, city):
              p = ''.join(lazy_pinyin(province, style=Style.NORMAL))
              c = ''.join(lazy_pinyin(city, style=Style.NORMAL))
              return f"{c.title()}, {p.title()}"

          def optimize_data(df):
              print("Optimizing Data...")
              processed = set()
              result = []
              location_groups = defaultdict(list)
              
              for _, row in df.iterrows():
                  phone = str(row['phone'])
                  location_groups[f"{row['province']}{row['city']}"].append({
                      'phone': phone, 'province': row['province'], 'city': row['city']
                  })

              # ç¬¬ä¸€è½®ä¼˜åŒ–ï¼šåˆå¹¶å‰ç¼€
              for location, numbers in location_groups.items():
                  prefix_groups = defaultdict(list)
                  for num in numbers:
                      if num['phone'] not in processed:
                          prefix = num['phone'][:-1]
                          prefix_groups[prefix].append(num)
                  
                  for prefix, group in prefix_groups.items():
                      if len(group) == 10:
                          sorted_group = sorted(group, key=lambda x: x['phone'])
                          if all(int(n['phone'][-1]) == i for i, n in enumerate(sorted_group)):
                              first = sorted_group[0]
                              result.append({'phone': int(prefix), 'province': first['province'], 'city': first['city']})
                              processed.update(n['phone'] for n in sorted_group)

              # è¡¥å…¨å‰©ä½™å·ç 
              for _, row in df.iterrows():
                  phone = str(row['phone'])
                  if phone not in processed:
                      result.append({'phone': int(phone), 'province': row['province'], 'city': row['city']})
              
              # å†æ¬¡æ’åº
              final_df = pd.DataFrame(result)
              final_df.sort_values(by='phone', inplace=True)
              return final_df

          def generate_dart(final_df):
              print("Generating Dart files...")
              optimized_zh = {}
              optimized_en = {}
              
              for _, row in final_df.iterrows():
                  phone = row['phone']
                  optimized_zh[phone] = f"{row['province']}{row['city']}"
                  optimized_en[phone] = convert_to_pinyin(row['province'], row['city'])

              # ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šç›´æ¥å†™å…¥ phone_location_zh.dart å’Œ phone_location_en.dart
              # è¿™æ ·å°±è¦†ç›–äº†åŸä»“åº“çš„æ–‡ä»¶
              
              with open('lib/cn/phone_location_zh.dart', 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions - Optimized Version\n')
                  f.write('Map<int, String> get86_zh() {\n  return {\n')
                  for k, v in optimized_zh.items(): f.write(f'    {k}: "{v}",\n')
                  f.write('  };\n}\n')

              with open('lib/cn/phone_location_en.dart', 'w', encoding='utf-8') as f:
                  f.write('// Generated by GitHub Actions - Optimized Version\n')
                  f.write('Map<int, String> get86_en() {\n  return {\n')
                  for k, v in optimized_en.items(): f.write(f'    {k}: "{v}",\n')
                  f.write('  };\n}\n')

          # --- ä¸»æ‰§è¡Œæµç¨‹ ---
          if __name__ == "__main__":
              download_and_convert_sql()
              df = preprocess_csv()
              
              # ä¸ºäº†ä¿è¯é€»è¾‘ä¸€è‡´ï¼Œè¿™é‡Œæ¨¡æ‹Ÿä½ è„šæœ¬é‡Œçš„ä¸¤è½®å¤„ç†ï¼ˆè™½ç„¶é€»è¾‘ä¸Šå¯ä»¥ç›´æ¥ç”¨ dfï¼‰
              # ç›´æ¥å¤ç”¨ä¼˜åŒ–é€»è¾‘
              final_df = optimize_data(df)
              
              # å†æ¬¡è¿è¡Œä¸€éä¼˜åŒ–ä»¥ç¡®ä¿è¦†ç›–ï¼ˆæ ¹æ®ä½ åŸè„šæœ¬é€»è¾‘æ˜¯è·‘ä¸¤è½®ï¼Œè¿™é‡Œç®€åŒ–åˆå¹¶ï¼‰
              # å¦‚æœä½ éœ€è¦ä¸¥æ ¼çš„ä¸¤è½® CSV IO æ“ä½œï¼Œå¯ä»¥ä¿ç•™åŸæ ·ï¼Œè¿™é‡Œç›´æ¥ç”Ÿæˆæœ€ç»ˆç»“æœ
              generate_dart(final_df)
              print("Done.")
          EOF
          
          python run_all.py

      # 4. æäº¤å¹¶è¦†ç›–
      - name: Commit and Force Push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-overwrite: Replace files with optimized version"
          file_pattern: "lib/cn/phone_location_*.dart"
          branch: main
          repository: .
