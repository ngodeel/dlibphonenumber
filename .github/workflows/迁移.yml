name: Run Migration Script

on:
  workflow_run:
    # 监听名为 "Update and Merge Phone Data" 的 Workflow
    # 注意：这里必须和上一个 YML 文件的 name: 字段完全一致
    workflows: ["Update and Merge Phone Data"]
    types:
      - completed

permissions:
  contents: write

jobs:
  migrate-data:
    runs-on: ubuntu-latest
    # 只有当上一个 Workflow 成功(success)时才执行，失败了不执行
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 检出触发上一个 workflow 的对应分支（通常是 main）
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Install dependencies
        run: dart pub get

      - name: Run migration script
        run: dart run tool/migrate.dart

      - name: Commit and Push Migration Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(data): Apply migration script"
          # 提交所有被 migrate.dart 修改过的文件
          file_pattern: "."
